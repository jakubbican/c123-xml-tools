<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analýza oprav penalizací</title>

    <!-- Google Fonts s system fallback -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Timing Design System z GitHub Pages -->
    <link rel="stylesheet" href="https://opencanoetiming.github.io/timing-design-system/dist/timing.min.css">

    <style>
        /* Override fontů - Google Fonts místo self-hosted */
        :root {
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        /* Layout */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-4);
        }

        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--color-border);
            border-radius: 50%;
            border-top-color: var(--color-accent);
            animation: spin 1s ease-in-out infinite;
            margin-left: var(--space-2);
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Level-based barvy pro analýzu penalizací */
        .level-0 { background-color: var(--color-bg-surface); }
        .level-1 { background-color: rgba(255, 149, 0, 0.15); }
        .level-2 { background-color: rgba(255, 149, 0, 0.25); }
        .level-3 { background-color: rgba(255, 149, 0, 0.40); }
        .level-4 { background-color: rgba(255, 59, 48, 0.30); }
        .level-5 { background-color: rgba(255, 59, 48, 0.50); }

        /* Light theme level colors */
        .theme-light .level-1,
        :root:not(.theme-dark) .level-1 { background-color: rgba(217, 119, 6, 0.15); }
        .theme-light .level-2,
        :root:not(.theme-dark) .level-2 { background-color: rgba(217, 119, 6, 0.25); }
        .theme-light .level-3,
        :root:not(.theme-dark) .level-3 { background-color: rgba(217, 119, 6, 0.40); }
        .theme-light .level-4,
        :root:not(.theme-dark) .level-4 { background-color: rgba(220, 38, 38, 0.30); }
        .theme-light .level-5,
        :root:not(.theme-dark) .level-5 { background-color: rgba(220, 38, 38, 0.50); }

        /* Dropzone text */
        .dropzone p {
            margin-top: var(--space-2);
            color: var(--color-text-muted);
        }

        /* Race row styling */
        .race-row td:first-child {
            font-weight: var(--font-medium);
            text-align: left;
        }

        /* Separator row */
        .separator-row td {
            height: var(--space-2);
            background-color: var(--color-bg-body);
            border: none;
        }

        /* Results section */
        #results {
            margin-top: var(--space-6);
        }

        #results h2 {
            margin-bottom: var(--space-2);
        }

        #results p {
            color: var(--color-text-secondary);
            margin-bottom: var(--space-4);
        }

        /* Table container for horizontal scroll */
        .table-responsive {
            margin-top: var(--space-4);
        }

        /* Gate cell */
        .gate-cell {
            text-align: center;
            min-width: 40px;
        }

        /* Copy button spacing */
        .copy-button {
            margin-bottom: var(--space-4);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="card">
            <div class="card-body">
                <h1>Analýza oprav penalizací kanoistických závodů</h1>

                <div class="dropzone" id="dropZone">
                    <label for="xmlFile" class="btn btn-primary">Vybrat soubor</label>
                    <input type="file" id="xmlFile" accept=".xml" style="display: none;">
                    <p>nebo přetáhněte soubor sem</p>
                </div>

                <div id="uploadStatus" class="alert" style="display: none;"></div>

                <div id="results" style="display: none;">
                    <h2>Výsledky analýzy</h2>
                    <p>Počet detekovaných ex-post oprav podle branek a závodů</p>

                    <button id="copyToClipboard" class="btn btn-secondary copy-button">Kopírovat tabulku do schránky</button>
                    <div class="table-responsive">
                        <table id="resultsTable" class="table table-striped table-hover">
                            <!-- Tabulka bude naplněna dynamicky -->
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Globální proměnné
        let xmlData = null;
        let parsedData = {
            results: [],
            courseConfigs: {},
            scheduleInfo: {}
        };

        // DOM elementy
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('xmlFile');
        const uploadStatus = document.getElementById('uploadStatus');
        const resultsDiv = document.getElementById('results');
        const resultsTable = document.getElementById('resultsTable');

        // Event listenery pro nahrávání souborů
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropZone.classList.add('drag-over');
        }

        function unhighlight() {
            dropZone.classList.remove('drag-over');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length > 0) {
                handleFile(files[0]);
            }
        }

        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                handleFile(this.files[0]);
            }
        });

        // Zpracování souboru
        function handleFile(file) {
            if (!file) return;

            if (file.type !== 'text/xml' && !file.name.endsWith('.xml')) {
                showStatus('Chyba: Je možné nahrát pouze XML soubory.', 'error');
                return;
            }

            showStatus('<span class="loading"></span> Načítání souboru...', 'info');

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    xmlData = e.target.result;
                    parseXmlData(xmlData);
                    showStatus(`Soubor ${file.name} byl úspěšně načten.`, 'success');

                    // Analyzovat data a zobrazit výsledky
                    analyzeAndDisplayResults();
                } catch (error) {
                    console.error('Chyba při zpracování souboru:', error);
                    showStatus(`Chyba při zpracování: ${error.message}`, 'error');
                }
            };

            reader.onerror = function() {
                showStatus('Chyba při čtení souboru.', 'error');
            };

            reader.readAsText(file);
        }

        // Helper pro zobrazení statusu
        function showStatus(message, type) {
            uploadStatus.innerHTML = message;
            uploadStatus.className = `alert alert-${type}`;
            uploadStatus.style.display = 'block';
        }

        // Parsování XML dat
        function parseXmlData(xmlContent) {
            try {
                // Vytvoření DOM objektu z XML
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlContent, "text/xml");

                // Kontrola chyby parsování
                const errorNode = xmlDoc.querySelector("parsererror");
                if (errorNode) {
                    throw new Error("Chyba při parsování XML");
                }

                // Extrakce výsledků
                const resultsNodes = xmlDoc.getElementsByTagName('Results');

                // Extrakce konfigurace tratí
                const courseDataNodes = xmlDoc.getElementsByTagName('CourseData');
                const courseConfigs = {};

                for (let i = 0; i < courseDataNodes.length; i++) {
                    const courseNr = courseDataNodes[i].getElementsByTagName('CourseNr')[0]?.textContent;
                    const config = courseDataNodes[i].getElementsByTagName('CourseConfig')[0]?.textContent;

                    if (courseNr && config) {
                        courseConfigs[courseNr] = config;
                    }
                }

                // Zpracování výsledků
                const results = [];

                for (let i = 0; i < resultsNodes.length; i++) {
                    const raceId = resultsNodes[i].getElementsByTagName('RaceId')[0]?.textContent;
                    const id = resultsNodes[i].getElementsByTagName('Id')[0]?.textContent;
                    const dtStart = resultsNodes[i].getElementsByTagName('dtStart')[0]?.textContent;
                    const dtFinish = resultsNodes[i].getElementsByTagName('dtFinish')[0]?.textContent;

                    // Kontrola, zda máme GateTimes a Gates
                    const gateTimesNode = resultsNodes[i].getElementsByTagName('GateTimes')[0];
                    const gatesNode = resultsNodes[i].getElementsByTagName('Gates')[0];

                    if (raceId && dtStart && dtFinish && gateTimesNode && gatesNode) {
                        const gates = gatesNode.textContent.trim().split(/\s+/).filter(Boolean);
                        const gateTimes = gateTimesNode.textContent.split(';').filter(Boolean);

                        results.push({
                            raceId,
                            id,
                            dtStart,
                            dtFinish,
                            gates,
                            gateTimes
                        });
                    }
                }

                // Extrakce rozvrhu (Schedule) pro získání informací o tratích
                const scheduleNodes = xmlDoc.getElementsByTagName('Schedule');
                const scheduleInfo = {};

                for (let i = 0; i < scheduleNodes.length; i++) {
                    const raceId = scheduleNodes[i].getElementsByTagName('RaceId')[0]?.textContent;

                    if (raceId && raceId !== '<unassigned>') {
                        const courseNr = scheduleNodes[i].getElementsByTagName('CourseNr')[0]?.textContent;
                        const customTitle = scheduleNodes[i].getElementsByTagName('CustomTitle')[0]?.textContent;
                        const classId = scheduleNodes[i].getElementsByTagName('ClassId')[0]?.textContent;
                        const startTime = scheduleNodes[i].getElementsByTagName('StartTime')[0]?.textContent;

                        if (courseNr) {
                            scheduleInfo[raceId] = {
                                courseNr,
                                customTitle: customTitle || raceId,
                                classId: classId || '',
                                startTime: startTime || ''
                            };
                        }
                    }
                }

                // Uložení zparsovaných dat
                parsedData = {
                    results,
                    courseConfigs,
                    scheduleInfo
                };

                return true;
            } catch (error) {
                console.error('Chyba při parsování XML:', error);
                throw error;
            }
        }

        // Analýza dat a zobrazení výsledků
        function analyzeAndDisplayResults() {
            // Získat všechny dostupné RaceId
            const allRaceIds = parsedData.results.map(result => result.raceId);
            const uniqueRaceIds = [...new Set(allRaceIds)].sort();

            // Získat maximální počet branek
            let maxGates = 0;
            parsedData.results.forEach(result => {
                if (result.gates.length > maxGates) {
                    maxGates = result.gates.length;
                }
            });

            // Mapování RaceId na informace o trati
            const raceCourseMappings = {};
            for (const raceId of uniqueRaceIds) {
                if (parsedData.scheduleInfo[raceId]) {
                    raceCourseMappings[raceId] = parsedData.scheduleInfo[raceId].courseNr;
                }
            }

            // Struktura pro uložení výsledků analýzy
            const analysisResults = {};

            // Analýza pro každý RaceId
            for (const raceId of uniqueRaceIds) {
                const courseNr = raceCourseMappings[raceId];
                const courseConfig = parsedData.courseConfigs[courseNr] || '';

                // Získání všech jízd pro tento RaceId
                const racesOfType = parsedData.results.filter(result => result.raceId === raceId);

                // Příprava pole pro uložení počtu ex-post oprav pro každou branku
                const gateEdits = Array(maxGates).fill(0);

                // Identifikace segmentů
                const segments = [];
                let currentSegment = [];
                let segmentIndex = 0;

                if (courseConfig) {
                    for (let i = 0; i < courseConfig.length; i++) {
                        if (courseConfig[i] === 'S') {
                            if (currentSegment.length > 0) {
                                segments.push({
                                    gates: currentSegment,
                                    index: segmentIndex
                                });
                                currentSegment = [];
                                segmentIndex++;
                            }
                        } else {
                            currentSegment.push({
                                type: courseConfig[i],
                                gateIndex: i
                            });
                        }
                    }

                    // Přidání posledního segmentu, pokud existuje
                    if (currentSegment.length > 0) {
                        segments.push({
                            gates: currentSegment,
                            index: segmentIndex
                        });
                    }
                }

                // Analýza každé jízdy pro tento RaceId
                racesOfType.forEach(race => {
                    const { dtStart, dtFinish, gates, gateTimes } = race;

                    // Převod časů na milisekundy od půlnoci
                    const startTimeMs = timeToMilliseconds(dtStart);
                    const finishTimeMs = timeToMilliseconds(dtFinish);

                    // Převod časů branek na milisekundy
                    const gateTimeValues = gateTimes.map(time => parseInt(time, 10));

                    // Zjištění, zda čas zadání je mimo interval jízdy nebo výrazně odlišný
                    for (let i = 0; i < gateTimeValues.length && i < gates.length; i++) {
                        const gateTimeMs = gateTimeValues[i];

                        // Kontrola, zda je čas mimo interval jízdy
                        // Přidáváme malou toleranci (30 sekund) pro konec jízdy
                        const isOutsideRaceTime =
                            gateTimeMs < startTimeMs - 5000 || // 5 sekund před startem
                            gateTimeMs > finishTimeMs + 30000; // 30 sekund po dojezdu

                        // Čas je výrazně odlišný od ostatních?
                        let isSignificantlyDifferent = false;
                        if (gateTimeValues.length > 1) {
                            // Výpočet mediánu
                            const sortedTimes = [...gateTimeValues].sort((a, b) => a - b);
                            const median = sortedTimes[Math.floor(sortedTimes.length / 2)];

                            // Je rozdíl větší než práh (10 minut = 600000 ms)?
                            isSignificantlyDifferent = Math.abs(gateTimeMs - median) > 600000;
                        }

                        // Pokud je čas podezřelý, počítáme to jako ex-post opravu
                        if (isOutsideRaceTime || isSignificantlyDifferent) {
                            gateEdits[i]++;
                        }
                    }
                });

                // Uložení výsledků analýzy
                analysisResults[raceId] = {
                    courseNr,
                    courseConfig,
                    gates: gateEdits,
                    segments: segments,
                    runsCount: racesOfType.length
                };
            }

            // Vytvoření tabulky
            createResultsTable(analysisResults, maxGates);

            // Zobrazení výsledků
            resultsDiv.style.display = 'block';

            // Event listener pro kopírování tabulky
            document.getElementById('copyToClipboard').addEventListener('click', () => {
                copyTableToClipboard(resultsTable);
            });
        }

        // Vytvoření tabulky s výsledky
        function createResultsTable(analysisResults, maxGates) {
            resultsTable.innerHTML = '';

            // Vytvoření záhlaví
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            // Prázdná buňka pro první sloupec (RaceId)
            const thFirst = document.createElement('th');
            thFirst.textContent = 'Závod';
            headerRow.appendChild(thFirst);

            // Záhlaví pro každou branku
            for (let i = 0; i < maxGates; i++) {
                const th = document.createElement('th');
                th.textContent = `${i + 1}`;
                th.className = 'cell-numeric';
                headerRow.appendChild(th);
            }

            thead.appendChild(headerRow);
            resultsTable.appendChild(thead);

            // Vytvoření těla tabulky
            const tbody = document.createElement('tbody');

            // Seřazení závodů podle StartTime
            const sortedRaceIds = Object.keys(analysisResults).sort((a, b) => {
                const startTimeA = parsedData.scheduleInfo[a]?.startTime || '';
                const startTimeB = parsedData.scheduleInfo[b]?.startTime || '';

                return startTimeA.localeCompare(startTimeB);
            });

            // Vytvoření řádků pro každou jízdu
            for (const raceId of sortedRaceIds) {
                const raceData = analysisResults[raceId];

                // Řádek pro jízdu
                const raceRow = document.createElement('tr');
                raceRow.className = 'race-row';

                // První sloupec - RaceId
                const raceIdCell = document.createElement('td');
                raceIdCell.textContent = raceId;
                raceRow.appendChild(raceIdCell);

                // Sloupce pro každou branku
                for (let i = 0; i < maxGates; i++) {
                    const td = document.createElement('td');
                    td.className = 'gate-cell cell-numeric';

                    if (i < raceData.gates.length) {
                        const editCount = raceData.gates[i];
                        if (editCount > 0) {
                            td.textContent = editCount;

                            // Barevné označení podle počtu oprav
                            if (editCount === 1) td.classList.add('level-1');
                            else if (editCount === 2) td.classList.add('level-2');
                            else if (editCount === 3) td.classList.add('level-3');
                            else if (editCount === 4) td.classList.add('level-4');
                            else if (editCount >= 5) td.classList.add('level-5');
                        } else {
                            td.textContent = '';
                            td.classList.add('level-0');
                        }
                    }

                    raceRow.appendChild(td);
                }

                tbody.appendChild(raceRow);
            }

            resultsTable.appendChild(tbody);
        }

        // Kopírování tabulky do schránky
        function copyTableToClipboard(table) {
            let tsv = '';

            // Projít všechny řádky tabulky
            for (let i = 0; i < table.rows.length; i++) {
                const row = table.rows[i];
                const rowData = [];

                // Projít všechny buňky v řádku
                for (let j = 0; j < row.cells.length; j++) {
                    rowData.push(row.cells[j].textContent);
                }

                // Přidat řádek do TSV
                tsv += rowData.join('\t') + '\n';
            }

            // Kopírovat do schránky
            navigator.clipboard.writeText(tsv)
                .then(() => {
                    alert('Tabulka byla zkopírována do schránky');
                })
                .catch(err => {
                    console.error('Chyba při kopírování:', err);
                    alert('Nepodařilo se zkopírovat tabulku do schránky');
                });
        }

        // Funkce pro převod časového formátu (HH:MM:SS.mmm) na milisekundy od půlnoci
        function timeToMilliseconds(timeStr) {
            if (!timeStr) return 0;

            const parts = timeStr.split(':');
            if (parts.length < 3) return 0;

            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);

            let seconds = 0;
            if (parts[2].includes('.')) {
                const secParts = parts[2].split('.');
                seconds = parseInt(secParts[0], 10);
                const milliseconds = parseInt(secParts[1], 10);
                seconds += milliseconds / 1000;
            } else {
                seconds = parseInt(parts[2], 10);
            }

            return (hours * 3600 + minutes * 60 + seconds) * 1000;
        }
    </script>
</body>
</html>
